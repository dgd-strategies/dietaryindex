#' MEDI_NHANES_FPED
#'
#' Calculate the MEDI (serving size-based) using a binary cutoff for the NHANES_FPED data (after 2005) within 1 step
#' @import dplyr
#' @import readr
#' @import haven
#' @param FPED_IND_PATH The file path for the FPED IND data. The file name should be like: fped_dr1iff.sas7bdat
#' @param NUTRIENT_IND_PATH The file path for the NUTRIENT IND data. The file name should be like: DR1IFF_J
#' @param FPED_IND_PATH2 The file path for the FPED IND data for day 2. The file name should be like: fped_dr1iff.sas7bdat
#' @param NUTRIENT_IND_PATH2 The file path for the NUTRIENT IND data for day 2. The file name should be like: DR2IFF_J
#' @param SWEETS_code The code for sweets in the FPED data. The default food codes are from the FPED data for NHANES 2017-2018
#' @param FAT_OIL_code The code for fat and oil in the FPED data. The default food codes are from the FPED data for NHANES 2017-2018
#' @param SSB_code The code for sugar-sweetened beverages in the FPED data. The default food codes are from the FPED data for NHANES 2017-2018
#' @param OLIVE_OIL_code The code for olive oil in the FPED data. The default food codes are from the FPED data for NHANES 2017-2018
#' @return The MEDI and its component scores and serving sizes
#' @examples
#' data("NHANES_20172018")
#' MEDI_NHANES_FPED(FPED_IND_PATH = NHANES_20172018$FPED_IND, NUTRIENT_IND_PATH = NHANES_20172018$NUTRIENT_IND, FPED_IND_PATH2 = NHANES_20172018$FPED_IND2, NUTRIENT_IND_PATH2 = NHANES_20172018$NUTRIENT_IND2)
#' @export

MEDI_NHANES_FPED = function(FPED_IND_PATH = NULL, NUTRIENT_IND_PATH = NULL, FPED_IND_PATH2 = NULL, NUTRIENT_IND_PATH2 = NULL, SWEETS_code = NULL, FAT_OIL_code = NULL, SSB_code = NULL, OLIVE_OIL_code = NULL) {
    # stop if the input data is not provided for any day
    if (is.null(FPED_IND_PATH) & is.null(NUTRIENT_IND_PATH) & is.null(FPED_IND_PATH2) & is.null(NUTRIENT_IND_PATH2)) {
        stop("Please provide the file path for the FPED and NUTRIENT data, day 1 or day 2 or day 1 and day 2.")
    }

    if (is.null(SSB_code)) {
        # load the SSB codes from 17-18 FNDDS file as default
        COFFEE = c(12200100, 12210200, 12210210, 12210260, 12210270, 12210280, 12210310, 12210400, 12210420, 12210430, 12210440, 12210505, 12210520, 91703600, 92100000, 92100500, 92101000, 92101500, 92101600, 92101610, 92101630, 92101700, 92101800, 92101810, 92101820, 92101850, 92101851, 92101900, 92101901, 92101903, 92101904, 92101905, 92101906, 92101910, 92101911, 92101913, 92101917, 92101918, 92101919, 92101920, 92101921, 92101923, 92101925, 92101926, 92101928, 92101930, 92101931, 92101933, 92101935, 92101936, 92101938, 92101950, 92101955, 92101960, 92101965, 92101970, 92101975, 92102000, 92102010, 92102020, 92102030, 92102040, 92102050, 92102060, 92102070, 92102080, 92102090, 92102100, 92102110, 92102400, 92102401, 92102450, 92102500, 92102501, 92102502, 92102503, 92102504, 92102505, 92102510, 92102511, 92102512, 92102513, 92102514, 92102515, 92102600, 92102601, 92102602, 92102610, 92102611, 92102612, 92103000, 92104000, 92111000, 92111010, 92114000, 92121000, 92121001, 92121010, 92121020, 92121030, 92121040, 92121041, 92121050, 92130000, 92130001, 92130005, 92130006, 92130010, 92130011, 92130020, 92130021, 92130030, 92130031, 92152000, 92152010, 92161000, 92161001, 92161002, 92162000, 92162001, 92162002, 92171000, 92171010, 92191100, 92191105, 92191200, 92191400, 92192000, 92192030, 92192040, 92193000, 92193005, 92193020, 92193025, 92201010, 92291300, 93202000, 93301400)
        TEA = c(53246000, 92302000, 92302500, 92303010, 92303100, 92304100, 92305010, 92305040, 92305050, 92305090, 92305110, 92305180, 92305900, 92305910, 92305920, 92306000, 92306090, 92306700, 92306800, 92307000, 92307400, 92308000, 92308010, 92308020, 92308030, 92308040, 92308050, 92308500, 92308510, 92308520, 92308530, 92308540, 92308550, 92309000, 92309010, 92309020, 92309030, 92309040, 92309050, 92309500, 92309510, 92309520)
        COFFEE_TEA = c(COFFEE, TEA)
        DRINK = c(
            11511100, 11511200, 11511300, 11511400, 11511550, 11511600, 11511610, 11511700, 11512010, 11512020, 11512030, 11512100, 11512110, 11512120, 11553130, 11560000, 64134030, 67260000, 75200700, 91301130, 92101920, 92101921, 92101923, 92101925, 92101926, 92101928, 92101930, 92101931, 92101933, 92101935, 92101936, 92101938, 92102000, 92102010, 92102020, 92102030, 92102040, 92102050, 92102060, 92102070, 92102080, 92102090, 92102100, 92102110, 92307500, 92307510, 92307520, 92400000, 92400100, 92410310, 92410315, 92410320, 92410340, 92410350, 92410360, 92410370, 92410390, 92410400, 92410410, 92410420, 92410510, 92410520, 92410550, 92410560, 92410610, 92410620, 92410710, 92410720, 92410810, 92410820, 92411510, 92411520, 92411610, 92411620, 92432000, 92433000, 92510610, 92510650, 92510955, 92510960, 92511015, 92513000, 92513010, 92530410, 92530510, 92530610, 92530950, 92531030, 92541010, 92542000, 92550030, 92550035, 92550040, 92550110, 92550200, 92550370, 92550400, 92550405, 92550610, 92550620, 92552000, 92552010, 92552020, 92552030, 92582100, 92582110, 92900100, 92900110, 92900200, 92900300, 93301216, 95101000, 95101010, 95102000, 95103000, 95103010, 95104000, 95105000, 95106000, 95106010, 95110000, 95110010, 95110020, 95120000, 95120010, 95120020, 95120050, 95310200, 95310400, 95310500, 95310550, 95310555, 95310560, 95310600, 95310700, 95310750, 95310800, 95311000, 95312400, 95312410, 95312500, 95312550, 95312555, 95312560, 95312600, 95312700, 95312800, 95312900, 95312905, 95313200, 95320200, 95320500, 95321000, 95322200, 95322500,
            95323000
        )
        SSB = c(COFFEE_TEA, DRINK)
        print("Since no SSB code is provided, the default SSB code from 17-18 FNDDS file is used.")
    } else {
        # use the provided SSB code
        SSB = SSB_code
    }

    if (is.null(SWEETS_code)) {
        # load the SSB codes from 17-18 FNDDS file as default
        SWEETS = c(11459990, 11460000, 11460100, 11460150, 11460160, 11460170, 11460190, 11460200, 11460250, 11460300, 11460400, 11460410, 11460420, 11460430, 11460440, 11461000, 11461200, 11461250, 11461260, 11461270, 11461280, 13110000, 13110100, 13110110, 13110120, 13110130, 13110140, 13110200, 13110210, 13110220, 13110310, 13110320, 13110330, 13120050, 13120100, 13120110, 13120120, 13120121, 13120130, 13120140, 13120300, 13120310, 13120400, 13120500, 13120550, 13120700, 13120710, 13120720, 13120730, 13120740, 13120750, 13120760, 13120770, 13120780, 13120790, 13121000, 13121100, 13121200, 13121300, 13121400, 13121500, 13122100, 13122500, 13126000, 13127000, 13127010, 13130100, 13130300, 13130310, 13130320, 13130330, 13130340, 13130590, 13130600, 13130610, 13130620, 13130630, 13130640, 13130700, 13135000, 13135010, 13136000, 13140100, 13140110, 13140450, 13140500, 13140550, 13140570, 13140575, 13140580, 13140600, 13140630, 13140650, 13140660, 13140670, 13140680, 13140700, 13140710, 13140900, 13142000, 13150000, 13160150, 13160160, 13160400, 13160410, 13160420, 13161000, 13161500, 13161520, 13161600, 13161630, 13170000, 13200110, 13210110, 13210150, 13210160, 13210180, 13210190, 13210220, 13210250, 13210260, 13210270, 13210280, 13210290, 13210300, 13210350, 13210410, 13210450, 13210500, 13210520, 13210530, 13210610, 13210710, 13210750, 13210810, 13210820, 13220110, 13220120, 13220210, 13220220, 13220230, 13220235, 13220240, 13220245, 13230110, 13230120, 13230130, 13230140, 13230200, 13230500, 13230510, 13241000, 13250000, 13250100, 13250200, 13252100, 13252200, 13252500, 13252600, 32120100, 32120200, 32401000, 41480000, 41480010, 44201000, 51000200, 51000300, 51000400, 51150000, 51153000, 51154010, 51154100, 51154510, 51154550, 51154600, 51155000, 51156500, 51157000, 51158100, 51159000, 51160000, 51160100, 51160110, 51161000, 51161020, 51161030, 51161050, 51161250, 51161270, 51161280, 51165000, 51166000, 51166100, 51166200, 51166500, 51167000, 51168000, 51180010, 51180030, 51180080, 51183990, 51184200, 51184210, 51184220, 51184230, 51184240, 51184250, 51184260, 51186010, 51186100, 51186130, 51186160, 51187020, 51188100, 51300100, 51301700, 51301750, 51301800, 51301805, 51301820, 51301900, 51302500, 51302520, 51303010, 51303030, 51303050, 51303070, 51303100, 51320010, 51320060, 51320070, 51320500, 51320550, 51320560, 51320700, 51320710, 51320720, 51401200, 51404500, 51404550, 51420000, 51421000, 51501080, 51502010, 51503000, 51503040, 51620000, 51620020, 51620030, 51630000, 51630100, 51630200, 51808100, 52101000, 52101030, 52101040, 52101050, 52101100, 52101150, 52102040, 52103000, 52104010, 52104040, 52104100, 52104200, 52105100, 52105200, 52201000, 52202060, 52206010, 52206060, 52207010, 52208010, 52208020, 52209010, 52211010, 52213010, 52220110, 52301000, 52302010, 52302020, 52302500, 52302600, 52303010, 52303500, 52304000, 52304010, 52304040, 52304100, 52304150, 52306010, 52306300, 52306500, 52306550, 52306700, 52311010, 52401000, 52403000, 52404060, 52405010, 52407000, 52408000, 53100050, 53100070, 53100100, 53101100, 53101200, 53101250, 53102100, 53102200, 53102600, 53102700, 53102800, 53103000, 53104100, 53104260, 53104300, 53104400, 53104500, 53104550, 53104600, 53105270, 53105275, 53105300, 53105500, 53106500, 53108200, 53108220, 53109200, 53109220, 53109300, 53110000, 53111000, 53112000, 53112100, 53113000, 53114000, 53114100, 53115100, 53115200, 53115310, 53115320, 53115410, 53115450, 53116000, 53116020, 53116270, 53116350, 53116390, 53116500, 53116510, 53116550, 53116570, 53116600, 53116650, 53117100, 53117200, 53118100, 53118200, 53118300, 53118410, 53118500, 53118550, 53119000, 53120270, 53120275, 53121270, 53121275, 53122070, 53122080, 53123070, 53123080, 53123500, 53124110, 53200100, 53201000, 53202000, 53203000, 53203500, 53204000, 53204010, 53204100, 53204840, 53204860, 53205250, 53205260, 53206000, 53206020, 53206030, 53206100, 53206500, 53206550, 53207000, 53207020, 53207050, 53208000, 53208200, 53209005, 53209010, 53209015, 53209020, 53209100, 53209500, 53210000, 53210900, 53211000, 53215500, 53220000, 53220010, 53220030, 53220040, 53222010, 53222020, 53223000, 53223100, 53224000, 53224250, 53225000, 53226000, 53226500, 53226550, 53226600, 53228000, 53230000, 53231000, 53231400, 53233000, 53233010, 53233040, 53233050, 53233060, 53233080, 53233100, 53234000, 53234100, 53234250, 53235000, 53235500, 53235600, 53236000, 53236100, 53237000, 53237010, 53237500, 53238000, 53239000, 53239010, 53239050, 53239100, 53240000, 53240010, 53241500, 53241510, 53241600, 53242000, 53242500, 53243000, 53243010, 53243050, 53244010, 53244020, 53246000, 53247000, 53247050, 53247500, 53251100, 53260030, 53260200, 53260300, 53260400, 53260500, 53260600, 53261000, 53270100, 53300100, 53300170, 53300180, 53301000, 53301070, 53301080, 53301500, 53301750, 53302000, 53302070, 53302080, 53303000, 53303070, 53303500, 53303510, 53303570, 53304000, 53304050, 53304070, 53305000, 53305010, 53305070, 53305080, 53305700, 53305720, 53305750, 53306000, 53306070, 53307000, 53307050, 53307070, 53307080, 53307500, 53307570, 53308000, 53308070, 53308300, 53308500, 53309000, 53309070, 53310000, 53310050, 53311000, 53311050, 53311070, 53312000, 53313000, 53314000, 53340000, 53340500, 53341000, 53341070, 53341500, 53341750, 53342000, 53342070, 53343000, 53343070, 53344000, 53344070, 53344200, 53344300, 53345000, 53345070, 53346000, 53346500, 53347000, 53347070, 53347100, 53347500, 53347600, 53348000, 53348070, 53360000, 53365000, 53366000, 53370000, 53371000, 53373000, 53381000, 53381070, 53382000, 53385000, 53385070, 53385500, 53386000, 53386050, 53386250, 53386500, 53387000, 53390000, 53390100, 53391000, 53391100, 53391150, 53391200, 53400200, 53400300, 53410100, 53410200, 53410300, 53410500, 53410800, 53410850, 53410860, 53410880, 53410900, 53415100, 53415120, 53415200, 53415220, 53415300, 53415400, 53415500, 53415600, 53420000, 53420100, 53420200, 53420210, 53420250, 53420300, 53420310, 53420400, 53420410, 53430000, 53430100, 53430200, 53430700, 53430750, 53440000, 53440300, 53440500, 53440600, 53440700, 53440750, 53440800, 53441110, 53441210, 53450000, 53450300, 53450500, 53450800, 53451000, 53451500, 53451750, 53452100, 53452120, 53452130, 53452150, 53452170, 53452200, 53452400, 53452420, 53452450, 53452500, 53453150, 53453170, 53500100, 53510000, 53510100, 53511000, 53520000, 53520110, 53520120, 53520140, 53520150, 53520160, 53520200, 53520500, 53520600, 53520700, 53521100, 53521110, 53521120, 53521130, 53521140, 53521210, 53521220, 53521230, 53530000, 53530010, 53610100, 53610170, 53610200, 54102010, 54102015, 54102020, 54102050, 54102060, 54102100, 54102200, 55100005, 55100010, 55100015, 55100020, 55100025, 55100030, 55100035, 55100040, 55100050, 55100055, 55100060, 55100065, 55100070, 55100080, 55101000, 55101015, 55103000, 55103020, 55103100, 55105000, 55105100, 55105200, 55105205, 55106000, 55200010, 55200020, 55200030, 55200040, 55200050, 55200060, 55200070, 55200080, 55200090, 55200100, 55200110, 55200120, 55200130, 55200200, 55201000, 55203000, 55203600, 55203700, 55204000, 55205000, 55208000, 55211050, 55212000, 55300010, 55300020, 55300030, 55300040, 55300050, 55300055, 55300060, 55301000, 55301010, 55301015, 55301020, 55301025, 55301030, 55301031, 55301040, 55301048, 55301050, 55301055, 55310100, 55400010, 55401000, 55501000, 55610300, 55702100, 55801000, 55801010, 56201550, 56205200, 56205230, 56205240, 58117110, 58117210, 58118110, 58118210, 58123120, 58124210, 58149160, 58157110, 58157210, 61113500, 63113030, 63203700, 63403150, 63420100, 63420110, 63420200, 63430100, 63430110, 63430500, 71930200, 71945020, 91101000, 91101010, 91101020, 91102010, 91104100, 91300010, 91300100, 91301020, 91301030, 91301040, 91301050, 91301060, 91301080, 91301081, 91301082, 91301090, 91301100, 91301120, 91301130, 91301200, 91301250, 91301510, 91302010, 91302020, 91303000, 91303500, 91304010, 91304020, 91304030, 91304040, 91304050, 91304060, 91304070, 91304080, 91304090, 91304250, 91304300, 91305010, 91305020, 91306020, 91306025, 91306030, 91306040, 91351010, 91351020, 91361020, 91361040, 91401000, 91402000, 91403000, 91404000, 91405000, 91405500, 91406000, 91406500, 91406600, 91407100, 91407120, 91407150, 91501010, 91501015, 91501020, 91501030, 91501040, 91501050, 91501060, 91501070, 91501080, 91501090, 91501100, 91501110, 91501120, 91511010, 91511020, 91511030, 91511050, 91511060, 91511070, 91511080, 91511090, 91511100, 91511110, 91512010, 91520100, 91550100, 91550300, 91560100, 91580000, 91601000, 91611000, 91611050, 91611100, 91621000, 91700010, 91700500, 91701010, 91701020, 91701030, 91702010, 91703010, 91703020, 91703030, 91703040, 91703050, 91703060, 91703070, 91703080, 91703150, 91703200, 91703250, 91703300, 91703400, 91703500, 91703600, 91705010, 91705020, 91705030, 91705040, 91705050, 91705060, 91705070, 91705090, 91705200, 91705300, 91705310, 91705400, 91705410, 91705420, 91705430, 91705500, 91706000, 91706100, 91706400, 91707000, 91707010, 91708000, 91708010, 91708020, 91708030, 91708040, 91708070, 91708100, 91708150, 91708160, 91709000, 91713010, 91713020, 91713030, 91713040, 91713050, 91713060, 91713070, 91713080, 91713090, 91713100, 91715000, 91715100, 91715200, 91715300, 91716010, 91716110, 91718000, 91718050, 91718100, 91718110, 91718200, 91718300, 91721000, 91723000, 91723010, 91723020, 91723050, 91726000, 91726110, 91726130, 91726140, 91726150, 91726410, 91726420, 91726425, 91727010, 91728000, 91728500, 91731000, 91731010, 91731060, 91731100, 91731150, 91732000, 91732100, 91733000, 91733200, 91734000, 91734100, 91734200, 91734300, 91734400, 91734450, 91734500, 91735000, 91736000, 91739010, 91739600, 91742010, 91745010, 91745020, 91745040, 91745100, 91746010, 91746100, 91746120, 91746150, 91746200, 91750000, 91760000, 91760100, 91760200, 91760500, 91760700, 91770000, 91770010, 91770020, 91770030, 91770050, 91800100, 91801000, 91802000)
        print("Since no SWEETS code is provided, the default SSB code from 17-18 FNDDS file is used")
    } else {
        # use the provided SWEETS code
        SWEETS = SWEETS
    }

    if(is.null(FAT_OIL_code)){
        FAT_OIL = c(22621100, 81100000, 81100500, 81101000, 81101010, 81101020, 81101100, 81101110, 81101120, 81101500, 81101520, 81201000, 81202000, 81203200, 81204000, 81322000, 82101000, 82101300, 82101500, 82102000, 82103000, 82103500, 82104000, 82105000, 82105500, 82105750, 82105800, 82106000, 82107000, 82108000, 82108250, 82108500, 82108700, 82109000, 83100100, 83101000, 83101600, 83102000, 83103000, 83104000, 83105500, 83106000, 83109000, 83112000, 83112500, 83112950, 83112990, 83114000, 83115000, 83200100, 83201000, 83201400, 83202020, 83203000, 83204500, 83205450, 83206000, 83206500, 83207000, 83208500, 83210100, 83300100, 83300200, 83300300, 83300400, 83300500, 83300600, 83300800, 83300900, 83301000)
        print("Since no FAT_OIL code is provided, the default FAT_OIL code from 17-18 FNDDS file is used")
    } else {
        FAT_OIL = FAT_OIL_code
    }

    if(is.null(OLIVE_OIL_code)){
        OLIVE_OIL = c(82104000)
        print("Since no OLIVE_OIL code is provided, the default OLIVE_OIL code from 17-18 FNDDS file is used")
    } else {
        OLIVE_OIL = OLIVE_OIL_code
    }


    # if only day 1 data is provided
    if (!is.null(FPED_IND_PATH) & !is.null(NUTRIENT_IND_PATH)) {
        if (is.character(FPED_IND_PATH) == TRUE) {
            FPED_IND = read_sas(FPED_IND_PATH)
        } else {
            FPED_IND = FPED_IND_PATH
        }

        if (is.character(NUTRIENT_IND_PATH) == TRUE) {
            NUTRIENT_IND = read_xpt(NUTRIENT_IND_PATH)
        } else {
            NUTRIENT_IND = NUTRIENT_IND_PATH
        }

        if (!("DR1ILINE" %in% colnames(FPED_IND)) | !("DR1ILINE" %in% colnames(NUTRIENT_IND))) {
            stop("Please use individual-level first day data. Individual-level nutrient data should be like DR1IFF_J.XPT. Individual-level FPED data should be like fped_dr1iff_1718.sas7bdat")
        }

        # Select the only the high quality data
        NUTRIENT_IND = NUTRIENT_IND %>%
            filter(DR1DRSTZ == 1) %>%
            arrange(SEQN)

        FPED_IND = FPED_IND %>%
            arrange(SEQN)

        # Merge the nutrient and food pattern data
        COHORT = NUTRIENT_IND %>%
            left_join(FPED_IND, by = c("SEQN", "DR1ILINE"))

        # Create the serving size for MEDI calculation
        COHORT = COHORT %>%
            dplyr::mutate(
                OLIVE_OIL_SERV = case_when(
                    DR1IFDCD.x %in% OLIVE_OIL ~ DR1IGRMS.x / 10,
                    TRUE ~ 0
                ),
                SWEETS_SERV_IND = case_when(
                    DR1IFDCD.x %in% SWEETS ~ DR1IGRMS.x / 50,
                    TRUE ~ 0
                ),
                FAT_OIL_SERV = case_when(
                    DR1IFDCD.x %in% FAT_OIL ~ DR1IGRMS.x / 10,
                    TRUE ~ 0
                ),
                ADDED_SUGAR_SSB_SERV = case_when(
                    DR1IFDCD.x %in% SSB ~ DR1I_ADD_SUGARS,
                    TRUE ~ 0
                )
            ) %>%
            dplyr::group_by(SEQN) %>%
            dplyr::summarize(
                OLIVE_OIL_SERV_MEDI = sum(OLIVE_OIL_SERV),
                FRT_SERV_MEDI = sum(DR1I_F_CITMLB + DR1I_F_OTHER),
                VEG_SERV_MEDI = sum(DR1I_V_DRKGR / 2 + DR1I_V_REDOR_TOTAL + DR1I_V_OTHER + DR1I_V_STARCHY_OTHER),
                LEGUMES_SERV_MEDI = sum((DR1I_V_LEGUMES * 4 + DR1I_PF_SOY) / 1.5),
                NUTS_SERV_MEDI = sum(DR1I_PF_NUTSDS),
                FISH_SEAFOOD_SERV_MEDI = sum((DR1I_PF_SEAFD_HI + DR1I_PF_SEAFD_LOW) / 4),
                ALCOHOL_SERV_MEDI = sum(DR1I_A_DRINKS),
                SSB_SERV_MEDI = sum((ADDED_SUGAR_SSB_SERV * 4 / 26)),
                SWEETS_SERV_MEDI = sum(SWEETS_SERV_IND),
                DISCRET_FAT_SERV_MEDI = sum(FAT_OIL_SERV),
                REDPROC_MEAT_SERV_MEDI = sum((DR1I_PF_CUREDMEAT + DR1I_PF_MEAT + DR1I_PF_ORGAN) / 5),
            )

        # Create the MEDI component and total scores
        COHORT = COHORT %>%
            dplyr::mutate(
                MEDI_OLIVE_OIL = case_when(OLIVE_OIL_SERV_MEDI >= 5 ~ 1, TRUE ~ 0),
                MEDI_FRT = case_when(FRT_SERV_MEDI >= 3 ~ 1, TRUE ~ 0),
                MEDI_VEG = case_when(VEG_SERV_MEDI >= 2 ~ 1, TRUE ~ 0),
                MEDI_LEGUMES = case_when(LEGUMES_SERV_MEDI >= 3 / 7 ~ 1, TRUE ~ 0),
                MEDI_NUTS = case_when(NUTS_SERV_MEDI >= 3 / 7 ~ 1, TRUE ~ 0),
                MEDI_FISH = case_when(FISH_SEAFOOD_SERV_MEDI >= 3 / 7 ~ 1, TRUE ~ 0),
                MEDI_ALCOHOL = case_when(ALCOHOL_SERV_MEDI >= 1 ~ 1, TRUE ~ 0),
                MEDI_SSB = case_when(SSB_SERV_MEDI < 1 ~ 1, TRUE ~ 0),
                MEDI_SWEETS = case_when(SWEETS_SERV_MEDI < 2 / 7 ~ 1, TRUE ~ 0),
                MEDI_DISCRET_FAT = case_when(DISCRET_FAT_SERV_MEDI < 1 ~ 1, TRUE ~ 0),
                MEDI_REDPROC_MEAT = case_when(REDPROC_MEAT_SERV_MEDI < 1 ~ 1, TRUE ~ 0),
                MEDI_ALL = MEDI_OLIVE_OIL + MEDI_FRT + MEDI_VEG + MEDI_LEGUMES + MEDI_NUTS + MEDI_FISH + MEDI_ALCOHOL + MEDI_SSB + MEDI_SWEETS + MEDI_DISCRET_FAT + MEDI_REDPROC_MEAT,
                MEDI_NOETOH = MEDI_FRT + MEDI_VEG + MEDI_LEGUMES + MEDI_NUTS + MEDI_FISH + MEDI_SSB + MEDI_SWEETS + MEDI_DISCRET_FAT + MEDI_REDPROC_MEAT
            ) %>%
            dplyr::select(
                SEQN, MEDI_ALL, MEDI_NOETOH,
                MEDI_OLIVE_OIL, MEDI_FRT, MEDI_VEG, MEDI_LEGUMES, MEDI_NUTS, MEDI_FISH, MEDI_ALCOHOL, MEDI_SSB, MEDI_SWEETS, MEDI_DISCRET_FAT, MEDI_REDPROC_MEAT
            )
    }

    # if only day 2 data is provided
    if (!is.null(FPED_IND_PATH2) & !is.null(NUTRIENT_IND_PATH2)) {
        if (is.character(FPED_IND_PATH2) == TRUE) {
            FPED_IND2 = read_sas(FPED_IND_PATH2)
        } else {
            FPED_IND2 = FPED_IND_PATH2
        }

        if (is.character(NUTRIENT_IND_PATH2) == TRUE) {
            NUTRIENT_IND2 = read_xpt(NUTRIENT_IND_PATH2)
        } else {
            NUTRIENT_IND2 = NUTRIENT_IND_PATH2
        }

        if (!("DR2ILINE" %in% colnames(FPED_IND2)) | !("DR2ILINE" %in% colnames(NUTRIENT_IND2))) {
            stop("Please use individual-level second day data. Individual-level nutrient data should be like DR2IFF_J.XPT. Individual-level FPED data should be like fped_DR2iff_1718.sas7bdat")
        }

        NUTRIENT_IND2 = NUTRIENT_IND2 %>%
            filter(DR2DRSTZ == 1) %>%
            arrange(SEQN)

        FPED_IND2 = FPED_IND2 %>%
            arrange(SEQN)

        COHORT2 = NUTRIENT_IND2 %>%
            left_join(FPED_IND2, by = c("SEQN", "DR2ILINE"))

        # Match participant response food frequency to the standard food frequency response code

        COHORT2 = COHORT2 %>%
            dplyr::mutate(
                OLIVE_OIL_SERV = case_when(
                    DR2IFDCD.x %in% OLIVE_OIL ~ DR2IGRMS.x / 10,
                    TRUE ~ 0
                ),
                SWEETS_SERV_IND = case_when(
                    DR2IFDCD.x %in% SWEETS ~ DR2IGRMS.x / 50,
                    TRUE ~ 0
                ),
                FAT_OIL_SERV = case_when(
                    DR2IFDCD.x %in% FAT_OIL ~ DR2IGRMS.x / 10,
                    TRUE ~ 0
                ),
                ADDED_SUGAR_SSB_SERV = case_when(
                    DR2IFDCD.x %in% SSB ~ DR2I_ADD_SUGARS,
                    TRUE ~ 0
                )
            ) %>%
            dplyr::group_by(SEQN) %>%
            dplyr::summarize(
                OLIVE_OIL_SERV_MEDI = sum(OLIVE_OIL_SERV),
                FRT_SERV_MEDI = sum(DR2I_F_CITMLB + DR2I_F_OTHER),
                VEG_SERV_MEDI = sum(DR2I_V_DRKGR / 2 + DR2I_V_REDOR_TOTAL + DR2I_V_OTHER + DR2I_V_STARCHY_OTHER),
                LEGUMES_SERV_MEDI = sum((DR2I_V_LEGUMES * 4 + DR2I_PF_SOY) / 1.5),
                NUTS_SERV_MEDI = sum(DR2I_PF_NUTSDS),
                FISH_SEAFOOD_SERV_MEDI = sum((DR2I_PF_SEAFD_HI + DR2I_PF_SEAFD_LOW) / 4),
                ALCOHOL_SERV_MEDI = sum(DR2I_A_DRINKS),
                SSB_SERV_MEDI = sum((ADDED_SUGAR_SSB_SERV * 4 / 26)),
                SWEETS_SERV_MEDI = sum(SWEETS_SERV_IND),
                DISCRET_FAT_SERV_MEDI = sum(FAT_OIL_SERV),
                REDPROC_MEAT_SERV_MEDI = sum((DR2I_PF_CUREDMEAT + DR2I_PF_MEAT + DR2I_PF_ORGAN) / 5),
            )


        COHORT2 = COHORT2 %>%
            dplyr::mutate(
                MEDI_OLIVE_OIL = case_when(OLIVE_OIL_SERV_MEDI >= 5 ~ 1, TRUE ~ 0),
                MEDI_FRT = case_when(FRT_SERV_MEDI >= 3 ~ 1, TRUE ~ 0),
                MEDI_VEG = case_when(VEG_SERV_MEDI >= 2 ~ 1, TRUE ~ 0),
                MEDI_LEGUMES = case_when(LEGUMES_SERV_MEDI >= 3 / 7 ~ 1, TRUE ~ 0),
                MEDI_NUTS = case_when(NUTS_SERV_MEDI >= 3 / 7 ~ 1, TRUE ~ 0),
                MEDI_FISH = case_when(FISH_SEAFOOD_SERV_MEDI >= 3 / 7 ~ 1, TRUE ~ 0),
                MEDI_ALCOHOL = case_when(ALCOHOL_SERV_MEDI >= 1 ~ 1, TRUE ~ 0),
                MEDI_SSB = case_when(SSB_SERV_MEDI < 1 ~ 1, TRUE ~ 0),
                MEDI_SWEETS = case_when(SWEETS_SERV_MEDI < 2 / 7 ~ 1, TRUE ~ 0),
                MEDI_DISCRET_FAT = case_when(DISCRET_FAT_SERV_MEDI < 1 ~ 1, TRUE ~ 0),
                MEDI_REDPROC_MEAT = case_when(REDPROC_MEAT_SERV_MEDI < 1 ~ 1, TRUE ~ 0),
                MEDI_ALL = MEDI_OLIVE_OIL + MEDI_FRT + MEDI_VEG + MEDI_LEGUMES + MEDI_NUTS + MEDI_FISH + MEDI_ALCOHOL + MEDI_SSB + MEDI_SWEETS + MEDI_DISCRET_FAT + MEDI_REDPROC_MEAT,
                MEDI_NOETOH = MEDI_FRT + MEDI_VEG + MEDI_LEGUMES + MEDI_NUTS + MEDI_FISH + MEDI_SSB + MEDI_SWEETS + MEDI_DISCRET_FAT + MEDI_REDPROC_MEAT
            ) %>%
            dplyr::select(
                SEQN, MEDI_ALL, MEDI_NOETOH,
                MEDI_OLIVE_OIL, MEDI_FRT, MEDI_VEG, MEDI_LEGUMES, MEDI_NUTS, MEDI_FISH, MEDI_ALCOHOL, MEDI_SSB, MEDI_SWEETS, MEDI_DISCRET_FAT, MEDI_REDPROC_MEAT
            )
    }

    if (!is.null(FPED_IND_PATH) & !is.null(NUTRIENT_IND_PATH) & is.null(FPED_IND_PATH2) & is.null(NUTRIENT_IND_PATH2)) {
        return(COHORT)
    }

    if (is.null(FPED_IND_PATH) & is.null(NUTRIENT_IND_PATH) & !is.null(FPED_IND_PATH2) & !is.null(NUTRIENT_IND_PATH2)) {
        return(COHORT2)
    }

    # merge two days data if they both exist by creating columns with the same name but taking average of the original column
    if (!is.null(FPED_IND_PATH) & !is.null(NUTRIENT_IND_PATH) & !is.null(FPED_IND_PATH2) & !is.null(NUTRIENT_IND_PATH2)) {
        COHORT12 <- inner_join(COHORT, COHORT2, by = "SEQN") %>%
            dplyr::mutate(
                MEDI_ALL = (MEDI_ALL.x + MEDI_ALL.y) / 2,
                MEDI_NOETOH = (MEDI_NOETOH.x + MEDI_NOETOH.y) / 2,
                MEDI_OLIVE_OIL = (MEDI_OLIVE_OIL.x + MEDI_OLIVE_OIL.y) / 2,
                MEDI_FRT = (MEDI_FRT.x + MEDI_FRT.y) / 2,
                MEDI_VEG = (MEDI_VEG.x + MEDI_VEG.y) / 2,
                MEDI_LEGUMES = (MEDI_LEGUMES.x + MEDI_LEGUMES.y) / 2,
                MEDI_NUTS = (MEDI_NUTS.x + MEDI_NUTS.y) / 2,
                MEDI_FISH = (MEDI_FISH.x + MEDI_FISH.y) / 2,
                MEDI_ALCOHOL = (MEDI_ALCOHOL.x + MEDI_ALCOHOL.y) / 2,
                MEDI_SSB = (MEDI_SSB.x + MEDI_SSB.y) / 2,
                MEDI_SWEETS = (MEDI_SWEETS.x + MEDI_SWEETS.y) / 2,
                MEDI_DISCRET_FAT = (MEDI_DISCRET_FAT.x + MEDI_DISCRET_FAT.y) / 2,
                MEDI_REDPROC_MEAT = (MEDI_REDPROC_MEAT.x + MEDI_REDPROC_MEAT.y) / 2
            ) %>%
            dplyr::select(
                SEQN, MEDI_ALL, MEDI_NOETOH,
                MEDI_OLIVE_OIL, MEDI_FRT, MEDI_VEG, MEDI_LEGUMES, MEDI_NUTS, MEDI_FISH, MEDI_ALCOHOL, MEDI_SSB, MEDI_SWEETS, MEDI_DISCRET_FAT, MEDI_REDPROC_MEAT
            )
        return(COHORT12)
    }
}
