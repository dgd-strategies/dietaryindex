#' HEI2015 Calculation
#'
#' Calculate the HEI2015 dietary index, Healthy eating index 2015, using given the serving sizes of foods and nutrients consumed per 1 day
#' @import dplyr
#' @import readr
#' @import haven
#' @param SERV_DATA The raw data file that includes all the serving sizes of foods and nutrients
#' @param RESPONDENTID The unique participant ID for each participant
#' @param TOTALKCAL_HEI2015 The total calorie from all foods and drinks 
#' @param TOTALFRT_SERV_HEI2015 The serving size of total fruits including fruit juice, unit= cup eq.
#' @param FRT_SERV_HEI2015 The serving size of Citrus, Melons, Berries + Other Intact Fruits, unit= cup eq.
#' @param VEG_SERV_HEI2015 The serving size of vegetables Total Vegetables + Legumes (Beans and Peas) in cup equivalents, unit= cup eq.
#' @param GREENNBEAN_SERV_HEI2015 The serving size of Dark Green Vegetables + Legumes (Beans and Peas) in cup equivalents, unit= cup eq.
#' @param TOTALPRO_SERV_HEI2015 The serving size of Total Meat, Poultry, and Seafood (including organ meats and cured meats) + Eggs + Nuts and Seeds + Soy + Legumes (Beans and Peas) in oz equivalents, unit=oz. eq., 1 cup legume = 4 oz
#' @param SEAPLANTPRO_SERV_HEI2015 The serving size of Seafood (high in n-3) + Seafood (low in n-3) + Soy + Nuts and Seeds + Legumes (Beans and Peas) in oz equivalents, unit=oz. eq., 1 cup legume = 4 oz
#' @param WHOLEGRAIN_SERV_HEI2015 The serving size of whole grains, unit=oz. eq.
#' @param DAIRY_SERV_HEI2015 The serving size of all dairy, unit=cup eq.
#' @param FATTYACID_SERV_HEI2015 The serving size of (Total Monounsaturated Fatty Acids + Total Polyunsaturated Fatty Acids)/Total Saturated Fatty Acids, unit=g
#' @param REFINEDGRAIN_SERV_HEI2015 The serving size of refined grains, unit=oz. eq.
#' @param SODIUM_SERV_HEI2015 The serving size of sodium, unit=g
#' @param ADDEDSUGAR_SERV_HEI2015 The serving size of added sugar, unit=\% of total energy, 1 tsp = 4g, 1g = 4kcal
#' @param SATFAT_SERV_HEI2015 The serving size of Total Saturated Fatty Acids, unit=\% of energy, 1g = 9 kcal
#' @return The HEI2015 index/score
#' @examples
#' data("HEI2015_VALIDATION")
#' HEI2015(SERV_DATA = HEI2015_VALIDATION,RESPONDENTID = HEI2015_VALIDATION$id,TOTALKCAL_HEI2015 = HEI2015_VALIDATION$kcal,TOTALFRT_SERV_HEI2015 = HEI2015_VALIDATION$total_fruit,FRT_SERV_HEI2015 = HEI2015_VALIDATION$whole_fruit,VEG_SERV_HEI2015 = HEI2015_VALIDATION$total_vegetable,GREENNBEAN_SERV_HEI2015 = HEI2015_VALIDATION$green_and_bean,TOTALPRO_SERV_HEI2015 = HEI2015_VALIDATION$total_protein,SEAPLANTPRO_SERV_HEI2015 = HEI2015_VALIDATION$seafood_plant_protein,WHOLEGRAIN_SERV_HEI2015 = HEI2015_VALIDATION$whole_grain,DAIRY_SERV_HEI2015 = HEI2015_VALIDATION$dairy,FATTYACID_SERV_HEI2015 = HEI2015_VALIDATION$fatty_acid,REFINEDGRAIN_SERV_HEI2015 = HEI2015_VALIDATION$refined_grain,SODIUM_SERV_HEI2015 = HEI2015_VALIDATION$sodium,ADDEDSUGAR_SERV_HEI2015 = HEI2015_VALIDATION$added_sugar,SATFAT_SERV_HEI2015 = HEI2015_VALIDATION$saturated_fat)
#' @export

#Score calculation for HEI2015
HEI2015 = function(SERV_DATA, RESPONDENTID, TOTALKCAL_HEI2015, TOTALFRT_SERV_HEI2015, FRT_SERV_HEI2015, VEG_SERV_HEI2015, GREENNBEAN_SERV_HEI2015, TOTALPRO_SERV_HEI2015,
                   SEAPLANTPRO_SERV_HEI2015, WHOLEGRAIN_SERV_HEI2015, DAIRY_SERV_HEI2015, FATTYACID_SERV_HEI2015, REFINEDGRAIN_SERV_HEI2015,
                   SODIUM_SERV_HEI2015, ADDEDSUGAR_SERV_HEI2015, SATFAT_SERV_HEI2015){
  
  ##Create variables needed for HEI2015 calculation
  HEI2015_MIN = 0
  HEI2015_MAX1 = 5
  HEI2015_MAX2 = 10
  
  HEI2015_MIN_TOTALFRT_SERV = 0
  HEI2015_MAX_TOTALFRT_SERV = 0.8
  HEI2015_MIN_FRT_SERV = 0
  HEI2015_MAX_FRT_SERV = 0.4
  HEI2015_MIN_VEG_SERV = 0
  HEI2015_MAX_VEG_SERV = 1.1
  HEI2015_MIN_GREENNBEAN_SERV = 0
  HEI2015_MAX_GREENNBEAN_SERV = 0.2
  HEI2015_MIN_TOTALPRO_SERV = 0
  HEI2015_MAX_TOTALPRO_SERV = 2.5
  HEI2015_MIN_SEAPLANTPRO_SERV = 0
  HEI2015_MAX_SEAPLANTPRO_SERV = 0.8
  HEI2015_MIN_WHOLEGRAIN_SERV = 0
  HEI2015_MAX_WHOLEGRAIN_SERV = 1.5
  HEI2015_MIN_DAIRY_SERV = 0
  HEI2015_MAX_DAIRY_SERV = 1.3
  HEI2015_MIN_FATTYACID_SERV = 1.2
  HEI2015_MAX_FATTYACID_SERV = 2.5
  
  HEI2015_MIN_REFINEDGRAIN_SERV = 4.3
  HEI2015_MAX_REFINEDGRAIN_SERV = 1.8
  HEI2015_MIN_SODIUM_SERV = 2.0
  HEI2015_MAX_SODIUM_SERV = 1.1
  HEI2015_MIN_ADDEDSUGAR_SERV = 26
  HEI2015_MAX_ADDEDSUGAR_SERV = 6.5
  HEI2015_MIN_SATFAT_SERV = 16
  HEI2015_MAX_SATFAT_SERV = 8
  
  HEI2015_HEALTHY1 = function(actual, min, max){
    case_when(
      actual >= max ~ HEI2015_MAX1,
      actual <= min ~ HEI2015_MIN,
      TRUE ~ HEI2015_MIN+(actual-min)*HEI2015_MAX1/(max-min)
    )
  }
  
  HEI2015_HEALTHY2 = function(actual, min, max){
    case_when(
      actual >= max ~ HEI2015_MAX2,
      actual <= min ~ HEI2015_MIN,
      TRUE ~ HEI2015_MIN+(actual-min)*HEI2015_MAX2/(max-min)
    )
  }
  
  HEI2015_UNHEALTHY = function(actual, min, max){
    case_when(
      actual >= min ~ HEI2015_MIN,
      actual <= max ~ HEI2015_MAX2,
      TRUE ~ HEI2015_MIN+(actual-min)*HEI2015_MAX2/(max-min)
    )
  }
  
  SERV_DATA=SERV_DATA %>%
    dplyr::mutate(
      RESPONDENTID = RESPONDENTID,
      TOTALKCAL_HEI2015 = TOTALKCAL_HEI2015,
      TOTALFRT_SERV_HEI2015 = TOTALFRT_SERV_HEI2015/(TOTALKCAL_HEI2015/1000),
      FRT_SERV_HEI2015 = (FRT_SERV_HEI2015)/(TOTALKCAL_HEI2015/1000),
      VEG_SERV_HEI2015 = (VEG_SERV_HEI2015)/(TOTALKCAL_HEI2015/1000),
      GREENNBEAN_SERV_HEI2015 = (GREENNBEAN_SERV_HEI2015)/(TOTALKCAL_HEI2015/1000),
      TOTALPRO_SERV_HEI2015 = (TOTALPRO_SERV_HEI2015)/(TOTALKCAL_HEI2015/1000),
      SEAPLANTPRO_SERV_HEI2015 = (SEAPLANTPRO_SERV_HEI2015)/(TOTALKCAL_HEI2015/1000),
      WHOLEGRAIN_SERV_HEI2015 = WHOLEGRAIN_SERV_HEI2015/(TOTALKCAL_HEI2015/1000),
      DAIRY_SERV_HEI2015 = DAIRY_SERV_HEI2015/(TOTALKCAL_HEI2015/1000),
      FATTYACID_SERV_HEI2015 = FATTYACID_SERV_HEI2015,
      
      REFINEDGRAIN_SERV_HEI2015 = REFINEDGRAIN_SERV_HEI2015/(TOTALKCAL_HEI2015/1000),
      SODIUM_SERV_HEI2015 = (SODIUM_SERV_HEI2015)/(TOTALKCAL_HEI2015/1000),
      ADDEDSUGAR_SERV_HEI2015 = ADDEDSUGAR_SERV_HEI2015,
      SATFAT_SERV_HEI2015 = SATFAT_SERV_HEI2015,
      
      HEI2015_TOTALFRT = HEI2015_HEALTHY1(TOTALFRT_SERV_HEI2015, HEI2015_MIN_TOTALFRT_SERV, HEI2015_MAX_TOTALFRT_SERV),
      HEI2015_FRT = HEI2015_HEALTHY1(FRT_SERV_HEI2015, HEI2015_MIN_FRT_SERV, HEI2015_MAX_FRT_SERV),
      HEI2015_VEG = HEI2015_HEALTHY1(VEG_SERV_HEI2015, HEI2015_MIN_VEG_SERV, HEI2015_MAX_VEG_SERV),
      HEI2015_GREENNBEAN = HEI2015_HEALTHY1(GREENNBEAN_SERV_HEI2015, HEI2015_MIN_GREENNBEAN_SERV, HEI2015_MAX_GREENNBEAN_SERV),
      HEI2015_TOTALPRO = HEI2015_HEALTHY1(TOTALPRO_SERV_HEI2015, HEI2015_MIN_TOTALPRO_SERV, HEI2015_MAX_TOTALPRO_SERV),
      HEI2015_SEAPLANTPRO = HEI2015_HEALTHY1(SEAPLANTPRO_SERV_HEI2015, HEI2015_MIN_SEAPLANTPRO_SERV, HEI2015_MAX_SEAPLANTPRO_SERV),
      HEI2015_WHOLEGRAIN = HEI2015_HEALTHY2(WHOLEGRAIN_SERV_HEI2015, HEI2015_MIN_WHOLEGRAIN_SERV, HEI2015_MAX_WHOLEGRAIN_SERV),
      HEI2015_DAIRY = HEI2015_HEALTHY2(DAIRY_SERV_HEI2015, HEI2015_MIN_DAIRY_SERV, HEI2015_MAX_DAIRY_SERV),
      HEI2015_FATTYACID = HEI2015_HEALTHY2(FATTYACID_SERV_HEI2015, HEI2015_MIN_FATTYACID_SERV, HEI2015_MAX_FATTYACID_SERV),
      
      HEI2015_REFINEDGRAIN = HEI2015_UNHEALTHY(REFINEDGRAIN_SERV_HEI2015, HEI2015_MIN_REFINEDGRAIN_SERV, HEI2015_MAX_REFINEDGRAIN_SERV),
      HEI2015_SODIUM = HEI2015_UNHEALTHY(SODIUM_SERV_HEI2015, HEI2015_MIN_SODIUM_SERV, HEI2015_MAX_SODIUM_SERV),
      HEI2015_ADDEDSUGAR = HEI2015_UNHEALTHY(ADDEDSUGAR_SERV_HEI2015, HEI2015_MIN_ADDEDSUGAR_SERV, HEI2015_MAX_ADDEDSUGAR_SERV),
      HEI2015_SATFAT = HEI2015_UNHEALTHY(SATFAT_SERV_HEI2015, HEI2015_MIN_SATFAT_SERV, HEI2015_MAX_SATFAT_SERV),
      
      HEI2015_ALL= HEI2015_TOTALFRT + HEI2015_FRT + HEI2015_VEG + HEI2015_GREENNBEAN +
        HEI2015_TOTALPRO + HEI2015_SEAPLANTPRO + HEI2015_WHOLEGRAIN + HEI2015_DAIRY +
        HEI2015_FATTYACID + HEI2015_REFINEDGRAIN + HEI2015_SODIUM + HEI2015_ADDEDSUGAR +
        HEI2015_SATFAT
    ) 
  
  for(i in 1:length(SERV_DATA$TOTALKCAL_HEI2015)){
    if (SERV_DATA$TOTALKCAL_HEI2015[i] == 0){
      SERV_DATA$HEI2015_TOTALFRT[i] = 0
      SERV_DATA$HEI2015_FRT[i] = 0
      SERV_DATA$HEI2015_VEG[i] = 0
      SERV_DATA$HEI2015_GREENNBEAN[i] = 0
      SERV_DATA$HEI2015_TOTALPRO[i] = 0
      SERV_DATA$HEI2015_SEAPLANTPRO[i] = 0
      SERV_DATA$HEI2015_WHOLEGRAIN[i] = 0
      SERV_DATA$HEI2015_DAIRY[i] = 0
      SERV_DATA$HEI2015_FATTYACID[i] = 0
      SERV_DATA$HEI2015_REFINEDGRAIN[i] = 0
      SERV_DATA$HEI2015_ADDEDSUGAR[i] = 0
      SERV_DATA$HEI2015_ALL[i] = 0
    }
  }
  
  SERV_DATA %>%
    dplyr::select(RESPONDENTID, TOTALKCAL_HEI2015, HEI2015_ALL, HEI2015_TOTALFRT, HEI2015_FRT, HEI2015_VEG, HEI2015_GREENNBEAN,
                  HEI2015_TOTALPRO, HEI2015_SEAPLANTPRO, HEI2015_WHOLEGRAIN, HEI2015_DAIRY,
                  HEI2015_FATTYACID, HEI2015_REFINEDGRAIN, HEI2015_SODIUM, HEI2015_ADDEDSUGAR,
                  HEI2015_SATFAT)
}