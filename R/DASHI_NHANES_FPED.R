#' DASHI_NHANES_FPED
#'
#' Calculate the DASHI (serving size-based) for the NHANES_FPED data (after 2005) within 1 step  
#' @import dplyr
#' @import readr
#' @import haven
#' @param FPED_IND_PATH The file path for the FPED IND data. The file name should be like: fped_dr1iff.sas7bdat
#' @param NUTRIENT_IND_PATH The file path for the NUTRIENT IND data. The file name should be like: DR1IFF_J
#' @return The DASHI and its component scores and serving sizes
#' @examples
#' data("NHANES_20172018")
#' DASHI_NHANES_FPED(NHANES_20172018$FPED_IND, NHANES_20172018$NUTRIENT_IND)
#' @export


DASHI_NHANES_FPED = function(FPED_IND_PATH, NUTRIENT_IND_PATH){
  
  if (is.character(FPED_IND_PATH) == TRUE){
    FPED_IND = read_sas(FPED_IND_PATH)
  } else {
    FPED_IND = FPED_IND_PATH
  }
  
  if (is.character(NUTRIENT_IND_PATH) == TRUE){
    NUTRIENT_IND = read_xpt(NUTRIENT_IND_PATH)
  } else {
    NUTRIENT_IND = NUTRIENT_IND_PATH
  }
  
  if (!("DR1ILINE" %in% colnames(FPED_IND)) | !("DR1ILINE" %in% colnames(NUTRIENT_IND)) ){
    stop("Please use individual-level data for this function. Individual-level nutrient data should be like DR1IFF_J.XPT. Individual-level FPED data should be like fped_dr1iff_1718.sas7bdat")
  }
  
  NUTRIENT_IND = NUTRIENT_IND %>%
    filter(DR1DRSTZ == 1) %>%
    arrange(SEQN)
  
  FPED_IND = FPED_IND %>%
    arrange(SEQN)
  
  COHORT = NUTRIENT_IND %>%
    left_join(FPED_IND, by = c("SEQN", "DR1ILINE"))
  
  LOWF_MILK=c(11111160, 11111170, 11112120, 11112210, 11113000, 11114300, 11114320, 11115000, 11115100, 11115400, 11120000, 11121210, 11121300, 11212050)
  LOWF_CHEESE=c(14204010,14204020,14206010,14207010)

  SNACKS_SWEETS = c(13200110, 13210110, 13210150, 13210160, 13210180, 13210190, 13210220, 13210260, 13210270, 13210280, 13210300, 13210350, 13210410, 13210450, 13210500, 13210520, 13210530, 13210610, 13210710, 13210750, 13210810, 13210820, 13220110, 13220120, 13220230, 13220235, 13220240, 13220245, 13230110, 13230130, 13230200, 13230500, 13230510, 13241000, 13250000, 13250100, 13250200, 13252100, 13252200, 13252500, 13252600, 32120100, 32120200, 32401000, 44201000, 51184000, 51184100, 51185000, 51187000, 51187020, 51188500, 51306000, 51808050, 53100050, 53100070, 53100100, 53101100, 53101200, 53101250, 53102100, 53102200, 53102600, 53102700, 53102800, 53103000, 53104100, 53104260, 53104300, 53104400, 53104500, 53104550, 53104600, 53105270, 53105275, 53105300, 53105500, 53106500, 53108200, 53108220, 53109200, 53109220, 53109300, 53110000, 53111000, 53112000, 53112100, 53113000, 53114000, 53114100, 53115100, 53115200, 53115310, 53115320, 53115410, 53115450, 53116000, 53116020, 53116270, 53116350, 53116390, 53116500, 53116510, 53116550, 53116570, 53116600, 53116650, 53117100, 53117200, 53118100, 53118200, 53118300, 53118410, 53118500, 53118550, 53119000, 53120270, 53120275, 53121270, 53121275, 53122070, 53122080, 53123070, 53123080, 53123500, 53124110, 53200100, 53201000, 53202000, 53203000, 53203500, 53204000, 53204010, 53204100, 53204840, 53204860, 53205250, 53205260, 53206000, 53206020, 53206030, 53206100, 53206500, 53206550, 53207000, 53207020, 53207050, 53208000, 53208200, 53209005, 53209010, 53209015, 53209020, 53209100, 53209500, 53210000, 53210900, 53211000, 53215500, 53220000, 53220010, 53220030, 53220040, 53222010, 53222020, 53223000, 53223100, 53224000, 53224250, 53225000, 53226000, 53226500, 53226550, 53226600, 53228000, 53230000, 53231000, 53231400, 53233000, 53233010, 53233040, 53233050, 53233060, 53233080, 53233100, 53234000, 53234100, 53234250, 53235000, 53235500, 53235600, 53236000, 53236100, 53237000, 53237010, 53237500, 53238000, 53239000, 53239010, 53239050, 53239100, 53240000, 53240010, 53241500, 53241510, 53241600, 53242000, 53242500, 53243000, 53243010, 53243050, 53244010, 53244020, 53246000, 53247000, 53247050, 53247500, 53251100, 53261000, 53270100, 53300100, 53300170, 53300180, 53301000, 53301070, 53301080, 53301500, 53301750, 53302000, 53302070, 53302080, 53303000, 53303070, 53303500, 53303510, 53303570, 53304000, 53304050, 53304070, 53305000, 53305010, 53305070, 53305080, 53305700, 53305720, 53305750, 53306000, 53306070, 53307000, 53307050, 53307070, 53307080, 53307500, 53307570, 53308000, 53308070, 53308300, 53308500, 53309000, 53309070, 53310000, 53310050, 53311000, 53311050, 53311070, 53312000, 53313000, 53314000, 53340000, 53340500, 53341000, 53341070, 53341500, 53341750, 53342000, 53342070, 53343000, 53343070, 53344000, 53344070, 53344200, 53344300, 53345000, 53345070, 53346000, 53346500, 53347000, 53347070, 53347100, 53347500, 53347600, 53348000, 53348070, 53360000, 53365000, 53366000, 53370000, 53371000, 53373000, 53381000, 53381070, 53382000, 53385000, 53385070, 53385500, 53386000, 53386100, 53386250, 53386500, 53387000, 53390000, 53390100, 53391000, 53391100, 53391150, 53391200, 53410100, 53410200, 53410300, 53410500, 53410800, 53410850, 53410860, 53410880, 53410900, 53415100, 53415300, 53415400, 53415500, 53415600, 53440000, 53440300, 53440500, 53440600, 53440700, 53440750, 53440800, 53441110, 53441210, 53450000, 53450300, 53450500, 53450800, 53451000, 53451500, 53451750, 53453150, 53453170, 54001000, 54102010, 54102015, 54102020, 54102050, 54102060, 54102100, 54102200, 54103000, 54200100, 54201010, 54202020, 54204020, 54204030, 54301010, 54301020, 54301030, 54301100, 54304000, 54304005, 54304020, 54304100, 54304150, 54305010, 54305020, 54307000, 54308000, 54313000, 54318500, 54319000, 54319005, 54319020, 54319500, 54325000, 54325010, 54325060, 54326000, 54328000, 54328100, 54328105, 54328110, 54328120, 54328200, 54328210, 54336000, 54336100, 54337010, 54337020, 54337030, 54337060, 54338000, 54338010, 54338020, 54338100, 54339000, 54340100, 54340110, 54402200, 54402610, 54402700, 54403001, 54403005, 54403006, 54403010, 54403040, 54403045, 54403046, 54403051, 54403052, 54403053, 54403054, 54403055, 54403056, 54403057, 54403058, 54403059, 54403061, 54403062, 54403080, 54403081, 54403082, 54403083, 54403084, 54403085, 54403086, 54403087, 54403088, 54403089, 54403091, 54403092, 54403110, 54403120, 54403160, 54408000, 54408015, 54408016, 54408017, 54408030, 54408035, 54408070, 54408081, 54408082, 54408105, 54408110, 54408115, 54408190, 54408200, 54408210, 54408250, 54408260, 54408290, 54408300, 54408310, 54408400, 54408405, 54408410, 54408411, 54408415, 54408416, 54408420, 54408422, 54408430, 54408432, 54408450, 54408455, 54408456, 54408460, 54408462, 54408465, 54408466, 54408470, 54408475, 54408480, 54408485, 54408486, 54408487, 54420220, 54440010, 56116000, 58118110, 58118210, 58149160, 58157110, 58157210, 63403150, 63420100, 63420110, 63430100, 63430110, 63430500, 71200010, 71200100, 71200110, 71200120, 71200130, 71200140, 71200200, 71200210, 71200220, 71200230, 71200240, 71200300, 71200310, 71200400, 71200410, 71201050, 71201060, 71201200, 71201210, 71202000, 71202100, 71202500, 71202510, 71203010, 71203020, 71203030, 71205020, 71205030, 71205040, 91101000, 91101010, 91101020, 91102010, 91104100, 91301120, 91302010, 91302020, 91303000, 91303500, 91501010, 91501015, 91501020, 91501030, 91501040, 91501050, 91501060, 91501070, 91501080, 91501090, 91501100, 91501110, 91501120, 91512010, 91520100, 91550100, 91550300, 91560100, 91580000, 91601000, 91611000, 91611050, 91621000, 91700010, 91700500, 91701010, 91701020, 91701030, 91702010, 91703010, 91703020, 91703030, 91703040, 91703050, 91703060, 91703070, 91703150, 91703200, 91703250, 91703300, 91703400, 91703500, 91703600, 91705010, 91705020, 91705030, 91705040, 91705050, 91705060, 91705070, 91705090, 91705200, 91705300, 91705310, 91705400, 91705410, 91705420, 91705430, 91705500, 91706000, 91706100, 91706400, 91707000, 91707010, 91708000, 91708010, 91708020, 91708030, 91708040, 91708070, 91708100, 91708150, 91708160, 91709000, 91713010, 91713020, 91713030, 91713040, 91713050, 91713060, 91713070, 91713080, 91713090, 91713100, 91715000, 91715100, 91715200, 91715300, 91716010, 91716110, 91718000, 91718050, 91718100, 91718110, 91718200, 91718300, 91721000, 91723000, 91723010, 91723020, 91723050, 91726000, 91726110, 91726130, 91726140, 91726150, 91726410, 91726420, 91726425, 91727010, 91728000, 91728500, 91731000, 91731010, 91731060, 91731100, 91731150, 91732000, 91732100, 91733000, 91733200, 91734000, 91734100, 91734200, 91734300, 91734400, 91734450, 91734500, 91735000, 91736000, 91739010, 91739600, 91742010, 91745010, 91745020, 91745040, 91745100, 91746010, 91746100, 91746120, 91746150, 91746200, 91750000, 91760000, 91760100, 91760200, 91760500, 91760700, 91800100, 91801000)
  
  FAT_OIL = c(22621100,81100000,81100500,81101000,81101010,81101020,81101100,81101110,81101120,81101500,81101520,81201000,81202000,81203200,81204000,81322000,82101000,82101300,82101500,82102000,82103000,82103500,82104000,82105000,82105500,82105750,82105800,82106000,82107000,82108000,82108250,82108500,82108700,82109000,83100100,83101000,83101600,83102000,83103000,83104000,83105500,83106000,83109000,83112000,83112500,83112950,83112990,83114000,83115000,83200100,83201000,83201400,83202020,83203000,83204500,83205450,83206000,83206500,83207000,83208500,83210100,83300100,83300200,83300300,83300400,83300500,83300600,83300800,83300900,83301000)

  COHORT = COHORT %>%
    dplyr::mutate(
      LOWF_MILK_SERV = case_when(
        DR1IFDCD.x %in% LOWF_MILK ~ DR1I_D_MILK,
        TRUE ~ 0
      ),
      LOWF_CHEESECREAM_SERV = case_when(
        DR1IFDCD.x %in% LOWF_CHEESE ~ DR1I_D_CHEESE*4/1.5,
        TRUE ~ 0
      ),

      SNACKS_SWEETS_SERV_IND = case_when(
        DR1IFDCD.x %in% SNACKS_SWEETS ~ DR1IGRMS.x/23,
        TRUE ~ 0
      ),

      FAT_OIL_SERV = case_when(
        DR1IFDCD.x %in% FAT_OIL ~ DR1IGRMS.x/14,
        TRUE ~ 0
        )
    ) %>%
    dplyr::group_by(SEQN) %>%
    dplyr::summarize(
      DASHI_TOTALKCAL = sum(DR1IKCAL),
      VEG_SERV_DASHI = sum(DR1I_V_DRKGR + (DR1I_V_REDOR_TOTAL +  DR1I_V_OTHER + DR1I_V_STARCHY_OTHER)/0.5)/(DASHI_TOTALKCAL/2000),
      FRT_FRTJ_SERV_DASHI = sum(DR1I_F_TOTAL)/(DASHI_TOTALKCAL/2000),
      NUTSLEG_SERV_DASHI = sum((DR1I_V_LEGUMES/0.5) + (DR1I_PF_NUTSDS/2.67) + (DR1I_PF_SOY/0.5))/(DASHI_TOTALKCAL/2000),
      LOWF_DAIRY_SERV_DASHI = sum(LOWF_MILK_SERV+LOWF_CHEESECREAM_SERV+DR1I_D_YOGURT)/(DASHI_TOTALKCAL/2000),
      WGRAIN_SERV_DASHI = sum(DR1I_G_WHOLE)/(DASHI_TOTALKCAL/2000),
      WHITE_MEAT_SERV_DASHI = sum((DR1I_PF_POULT + DR1I_PF_SEAFD_HI + DR1I_PF_SEAFD_LOW)/2.5)/(DASHI_TOTALKCAL/2000),
      REDPROC_MEAT_SERV_DASHI = sum((DR1I_PF_CUREDMEAT+DR1I_PF_MEAT+DR1I_PF_ORGAN)/2.5)/(DASHI_TOTALKCAL/2000),
      FATOIL_SERV_DASHI = sum(FAT_OIL_SERV)/(DASHI_TOTALKCAL/2000),
      SNACKS_SWEETS_SERV_DASHI = sum(SNACKS_SWEETS_SERV_IND)/(DASHI_TOTALKCAL/2000),
      SODIUM_SERV_DASHI = sum(DR1ISODI)/(DASHI_TOTALKCAL/2000)
    )
    
  
##Create variables and functions needed for DASHI calculation
  DASHI_MIN = 0
  DASHI_MAX = 5
  
  DASHI_MIN_VEG_SERV = 0
  DASHI_MAX_VEG_SERV = 4
  DASHI_MIN_FRT_FRTJ_SERV = 0
  DASHI_MAX_FRT_FRTJ_SERV = 5
  DASHI_MIN_NUTSLEG_SERV = 0
  DASHI_MAX_NUTSLEG_SERV = 4/7
  DASHI_MIN_LOWF_DAIRY_SERV = 0
  DASHI_MAX_LOWF_DAIRY_SERV = 2
  DASHI_MIN_WGRAIN_SERV = 0
  DASHI_MAX_WGRAIN_SERV = 4
  DASHI_MIN_WHITEMEAT_SERV = 0
  DASHI_MAX_WHITEMEAT_SERV= 1.1

  DASHI_MIN_REDPROC_MEAT_SERV = 1.5
  DASHI_MAX_REDPROC_MEAT_SERV = 0.5
  DASHI_MIN_FATOIL_SERV = 6
  DASHI_MAX_FATOIL_SERV = 2.5
  DASHI_MIN_SNACKS_SWEETS_SERV = 4
  DASHI_MAX_SNACKS_SWEETS_SERV = 5/7
  DASHI_MIN_SODIUM_SERV = 3000
  DASHI_MAX_SODIUM_SERV = 1150
  
  DASHI_HEALTHY = function(actual, min, max){
    case_when(
      actual >= max ~ DASHI_MAX,
      actual <= min ~ DASHI_MIN,
      TRUE ~ DASHI_MIN+(actual-min)*DASHI_MAX/(max-min)
    )
  }
  
  DASHI_UNHEALTHY = function(actual, min, max){
    case_when(
      actual >= min ~ DASHI_MIN ,
      actual <= max ~ DASHI_MAX,
      TRUE ~ DASHI_MIN+(actual-min)*DASHI_MAX/(max-min)
    )
  }
  
  ##DASHI calculation
  COHORT %>%
    dplyr::mutate(
      DASHI_VEG = DASHI_HEALTHY(VEG_SERV_DASHI, DASHI_MIN_VEG_SERV, DASHI_MAX_VEG_SERV),
      DASHI_FRT = DASHI_HEALTHY(FRT_FRTJ_SERV_DASHI, DASHI_MIN_FRT_FRTJ_SERV, DASHI_MAX_FRT_FRTJ_SERV),
      DASHI_NUTSLEG = DASHI_HEALTHY(NUTSLEG_SERV_DASHI, DASHI_MIN_NUTSLEG_SERV, DASHI_MAX_NUTSLEG_SERV),
      DASHI_LOWFATDAIRY = DASHI_HEALTHY(LOWF_DAIRY_SERV_DASHI, DASHI_MIN_LOWF_DAIRY_SERV, DASHI_MAX_LOWF_DAIRY_SERV),
      DASHI_WGRAIN = DASHI_HEALTHY(WGRAIN_SERV_DASHI, DASHI_MIN_WGRAIN_SERV, DASHI_MAX_WGRAIN_SERV),
      DASHI_WHITEMEAT = DASHI_HEALTHY(WHITE_MEAT_SERV_DASHI, DASHI_MIN_WHITEMEAT_SERV, DASHI_MAX_WHITEMEAT_SERV),

      DASHI_REDPROC_MEAT = DASHI_UNHEALTHY(REDPROC_MEAT_SERV_DASHI, DASHI_MIN_REDPROC_MEAT_SERV, DASHI_MAX_REDPROC_MEAT_SERV),
      DASHI_FATOIL = DASHI_UNHEALTHY(FATOIL_SERV_DASHI, DASHI_MIN_FATOIL_SERV, DASHI_MAX_FATOIL_SERV),
      DASHI_SNACKS_SWEETS = DASHI_UNHEALTHY(SNACKS_SWEETS_SERV_DASHI, DASHI_MIN_SNACKS_SWEETS_SERV, DASHI_MAX_SNACKS_SWEETS_SERV),
      DASHI_SODIUM = DASHI_UNHEALTHY(SODIUM_SERV_DASHI, DASHI_MIN_SODIUM_SERV, DASHI_MAX_SODIUM_SERV),

      DASHI_ALL= DASHI_VEG + DASHI_FRT + DASHI_NUTSLEG + DASHI_LOWFATDAIRY +
        DASHI_WGRAIN + DASHI_WHITEMEAT + DASHI_REDPROC_MEAT + DASHI_FATOIL + DASHI_SNACKS_SWEETS + DASHI_SODIUM
    )%>%
    dplyr::select(SEQN, DASHI_ALL, DASHI_TOTALKCAL, DASHI_VEG, DASHI_FRT, DASHI_NUTSLEG, DASHI_LOWFATDAIRY, DASHI_WGRAIN,
                  DASHI_WHITEMEAT, DASHI_REDPROC_MEAT, DASHI_FATOIL, DASHI_SNACKS_SWEETS, DASHI_SODIUM,
                  
                  VEG_SERV_DASHI, FRT_FRTJ_SERV_DASHI, NUTSLEG_SERV_DASHI, LOWF_DAIRY_SERV_DASHI, WGRAIN_SERV_DASHI,
                  WHITE_MEAT_SERV_DASHI, REDPROC_MEAT_SERV_DASHI, FATOIL_SERV_DASHI, SNACKS_SWEETS_SERV_DASHI, SODIUM_SERV_DASHI
                  )

}